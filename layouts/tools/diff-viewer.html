{{ define "title" }}æ–‡æœ¬å·®å¼‚å¯¹æ¯”å·¥å…· - {{ .Site.Title }}{{ end }}

{{ define "main" }}
<!-- å¼•å…¥ jsdiff åº“ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jsdiff/5.1.0/diff.min.js"></script>

<div class="tool-container">
    <div class="card-content">
        <h1 class="text-3xl font-bold mb-6 text-gray-800 flex items-center">
            <svg class="w-6 h-6 mr-3 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
            </svg>
            æ–‡æœ¬å·®å¼‚å¯¹æ¯”ä¸åˆå¹¶
        </h1>

        <!-- é”™è¯¯æç¤ºåŒº -->
        <div id="messageBox" class="message-box"></div>

        <!-- æ§åˆ¶æ  -->
        <div class="flex flex-wrap items-center justify-between mb-4 gap-4">
            <div class="flex items-center space-x-4">
                <label class="font-semibold text-gray-700">å¯¹æ¯”æ¨¡å¼:</label>
                <select id="diffMode"
                    class="form-select border border-gray-300 rounded-md px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="lines">æŒ‰è¡Œå¯¹æ¯” (Line)</option>
                    <option value="chars">æŒ‰å­—ç¬¦å¯¹æ¯” (Char)</option>
                    <option value="words">æŒ‰å•è¯å¯¹æ¯” (Word)</option>
                    <option value="json">JSON å¯¹æ¯”</option>
                </select>
            </div>

            <div class="flex space-x-2">
                <button onclick="compareText()" class="tool-button bg-blue-600 text-white hover:bg-blue-700">
                    âš–ï¸ å¼€å§‹å¯¹æ¯”
                </button>
                <button onclick="clearAll()" class="tool-button bg-gray-200 text-gray-800 hover:bg-gray-300">
                    ğŸ§¹ æ¸…ç©º
                </button>
            </div>
        </div>

        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- åŸæ–‡æœ¬ -->
            <div class="flex flex-col">
                <div class="flex justify-between items-center mb-2">
                    <label for="oldText" class="font-semibold text-gray-700 text-lg">åŸå§‹æ–‡æœ¬ (Original)</label>
                    <button onclick="pasteTo('oldText')"
                        class="text-xs text-blue-600 hover:underline cursor-pointer">ç²˜è´´</button>
                </div>
                <textarea id="oldText" class="input-area" placeholder="åœ¨æ­¤è¾“å…¥æˆ–ç²˜è´´åŸå§‹æ–‡æœ¬..."></textarea>
            </div>

            <!-- æ–°æ–‡æœ¬ -->
            <div class="flex flex-col">
                <div class="flex justify-between items-center mb-2">
                    <label for="newText" class="font-semibold text-gray-700 text-lg">æ–°æ–‡æœ¬ (New)</label>
                    <button onclick="pasteTo('newText')"
                        class="text-xs text-blue-600 hover:underline cursor-pointer">ç²˜è´´</button>
                </div>
                <textarea id="newText" class="input-area" placeholder="åœ¨æ­¤è¾“å…¥æˆ–ç²˜è´´ä¿®æ”¹åçš„æ–‡æœ¬..."></textarea>
            </div>
        </div>

        <!-- ç»“æœå±•ç¤ºåŒºåŸŸ -->
        <div class="result-section">
            <div class="flex justify-between items-end mb-2 border-b pb-2">
                <h2 class="text-xl font-bold text-gray-800">å·®å¼‚è§†å›¾ (ç‚¹å‡»è‰²å—è¿›è¡Œåˆå¹¶æ“ä½œ)</h2>
                <div id="diffStats" class="text-sm text-gray-500 hidden">
                    <span class="mr-4 text-green-600">æ–°å¢: <span id="addCount">0</span></span>
                    <span class="text-red-600">åˆ é™¤: <span id="delCount">0</span></span>
                </div>
            </div>

            <div class="mb-2 text-xs text-gray-500 flex gap-4">
                <span class="flex items-center"><span class="w-3 h-3 bg-green-200 mr-1 inline-block"></span> ç»¿è‰²ï¼šæ–°å¢
                    (ç‚¹å‡»å¯æ‹’ç»)</span>
                <span class="flex items-center"><span class="w-3 h-3 bg-red-200 mr-1 inline-block"></span> çº¢è‰²ï¼šåˆ é™¤
                    (ç‚¹å‡»å¯æ’¤é”€)</span>
            </div>

            <!-- å·®å¼‚æ˜¾ç¤ºå®¹å™¨ -->
            <pre id="diffOutput" class="diff-container"></pre>
        </div>

        <!-- åˆå¹¶ç»“æœåŒºåŸŸ -->
        <div id="mergeSection" class="mt-8 hidden">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-xl font-bold text-gray-800">åˆå¹¶ç»“æœ (Result)</h2>
                <button onclick="copyResult()"
                    class="tool-button bg-green-600 text-white hover:bg-green-700 py-1 px-3 text-sm">
                    ğŸ“‹ å¤åˆ¶ç»“æœ
                </button>
            </div>
            <textarea id="mergeOutput" class="input-area bg-gray-50 border-blue-200" readonly
                placeholder="åˆå¹¶åçš„ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
        </div>

    </div>
</div>

<style>
    .tool-container {
        max-width: 1200px;
        margin: 40px auto;
        padding: 20px;
    }

    .card-content {
        background-color: var(--card-background-base);
        padding: 1.5rem;
        border-radius: var(--border-radius);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(5px);
        border: 1px solid #E0E0E0;
    }

    /* è¾“å…¥æ¡†æ ·å¼ */
    .input-area {
        width: 100%;
        height: 250px;
        padding: 1rem;
        border: 2px solid #E0E0E0;
        border-radius: var(--border-radius);
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 0.9rem;
        resize: vertical;
        outline: none;
        transition: border-color 0.2s;
        background-color: #F8F9FA;
        white-space: pre;
        overflow-x: auto;
    }

    .input-area:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(30, 136, 229, 0.2);
    }

    /* æŒ‰é’®æ ·å¼ */
    .tool-button {
        padding: 0.5rem 1.2rem;
        border-radius: 0.5rem;
        font-weight: 600;
        transition: all 0.2s;
        border: none;
        cursor: pointer;
    }

    .tool-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    /* ç»“æœå±•ç¤ºåŒºæ ·å¼ */
    .diff-container {
        width: 100%;
        min-height: 100px;
        max-height: 500px;
        overflow: auto;
        background-color: #FFFFFF;
        border: 1px solid #E5E7EB;
        border-radius: 0.5rem;
        padding: 1rem;
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 0.9rem;
        line-height: 1.5;
        white-space: pre-wrap;
        word-break: break-all;
    }

    /* å·®å¼‚é«˜äº®æ ·å¼ (åŸºç¡€) */
    .diff-chunk {
        cursor: pointer;
        transition: opacity 0.2s, background-color 0.2s;
        border-radius: 2px;
    }

    .diff-chunk:hover {
        filter: brightness(0.95);
        outline: 1px dashed rgba(0, 0, 0, 0.2);
    }

    /* çŠ¶æ€ï¼šæ–°å¢ */
    .diff-added {
        background-color: #D1FAE5;
        /* Light Green */
        color: #065F46;
    }

    /* çŠ¶æ€ï¼šæ–°å¢è¢«æ‹’ç» (Exclude) */
    .diff-added.excluded {
        background-color: #F3F4F6;
        /* Gray */
        color: #9CA3AF;
        text-decoration: line-through;
    }

    /* çŠ¶æ€ï¼šåˆ é™¤ */
    .diff-removed {
        background-color: #FEE2E2;
        /* Light Red */
        color: #991B1B;
        text-decoration: line-through;
    }

    /* çŠ¶æ€ï¼šåˆ é™¤è¢«æ’¤é”€ (Include) */
    .diff-removed.included {
        background-color: #E0E7FF;
        /* Light Blueish highlight to show it's kept */
        color: #1F2937;
        text-decoration: none;
        border-bottom: 2px solid #6366F1;
    }

    .diff-neutral {
        color: #374151;
        cursor: default;
    }

    /* è¡Œæ¨¡å¼ä¸‹çš„æ ·å¼ */
    .diff-line {
        display: block;
        padding: 0 4px;
    }

    /* å­—ç¬¦æ¨¡å¼ä¸‹çš„æ ·å¼ */
    .diff-char {
        display: inline;
    }

    .diff-line.diff-added::before {
        content: '+ ';
        user-select: none;
        opacity: 0.5;
    }

    .diff-line.diff-removed::before {
        content: '- ';
        user-select: none;
        opacity: 0.5;
    }

    .diff-line.diff-neutral::before {
        content: '  ';
        user-select: none;
        opacity: 0.5;
    }

    .message-box {
        padding: 1rem;
        border-radius: var(--border-radius);
        margin-bottom: 1rem;
        font-weight: 500;
        display: none;
    }

    .message-box.error {
        background-color: #FEE2E2;
        color: #EF4444;
        border: 1px solid #FCA5A5;
    }

    .message-box.info {
        background-color: #E3F2FD;
        color: #1E88E5;
        border: 1px solid #90CAF9;
    }
</style>

<script>
    const oldInput = document.getElementById('oldText');
    const newInput = document.getElementById('newText');
    const diffOutput = document.getElementById('diffOutput');
    const mergeOutput = document.getElementById('mergeOutput');
    const modeSelect = document.getElementById('diffMode');
    const diffStats = document.getElementById('diffStats');
    const addCountEl = document.getElementById('addCount');
    const delCountEl = document.getElementById('delCount');
    const messageBox = document.getElementById('messageBox');
    const mergeSection = document.getElementById('mergeSection');

    // çŠ¶æ€å­˜å‚¨
    let currentDiff = [];
    let mergeState = []; // true: include in result, false: exclude

    function showMessage(message, type = 'info') {
        messageBox.textContent = message;
        messageBox.className = 'message-box';
        messageBox.classList.add(type);
        messageBox.style.display = 'block';
        setTimeout(() => messageBox.style.display = 'none', 3000);
    }

    async function pasteTo(id) {
        try {
            const text = await navigator.clipboard.readText();
            document.getElementById(id).value = text;
        } catch (err) {
            showMessage('æ— æ³•è®¿é—®å‰ªè´´æ¿ï¼Œè¯·æ‰‹åŠ¨ç²˜è´´', 'error');
        }
    }

    function clearAll() {
        oldInput.value = '';
        newInput.value = '';
        diffOutput.innerHTML = '';
        mergeOutput.value = '';
        diffStats.classList.add('hidden');
        mergeSection.classList.add('hidden');
        currentDiff = [];
        mergeState = [];
    }

    function compareText() {
        const oldText = oldInput.value;
        const newText = newInput.value;
        const mode = modeSelect.value;

        if (!oldText && !newText) {
            showMessage('è¯·è¾“å…¥éœ€è¦å¯¹æ¯”çš„æ–‡æœ¬', 'error');
            return;
        }

        diffOutput.innerHTML = '';

        try {
            if (mode === 'lines') {
                currentDiff = Diff.diffLines(oldText, newText);
            } else if (mode === 'chars') {
                currentDiff = Diff.diffChars(oldText, newText);
            } else if (mode === 'words') {
                currentDiff = Diff.diffWords(oldText, newText);
            } else if (mode === 'json') {
                let oldJson = oldText, newJson = newText;
                try { oldJson = JSON.stringify(JSON.parse(oldText), null, 2); } catch (e) { }
                try { newJson = JSON.stringify(JSON.parse(newText), null, 2); } catch (e) { }
                currentDiff = Diff.diffLines(oldJson, newJson);
            }
        } catch (e) {
            console.error(e);
            showMessage('å¯¹æ¯”è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¾“å…¥å†…å®¹', 'error');
            return;
        }

        // åˆå§‹åŒ–åˆå¹¶çŠ¶æ€
        // Neutral: always included (true)
        // Added: default included (true) -> User can reject (false)
        // Removed: default excluded (false) -> User can keep (true)
        mergeState = currentDiff.map(part => !part.removed);

        renderDiff(mode);
        generateResult();

        // æ›´æ–°ç»Ÿè®¡
        let added = 0, removed = 0;
        currentDiff.forEach(part => {
            if (part.added) added += part.count;
            if (part.removed) removed += part.count;
        });
        addCountEl.innerText = added;
        delCountEl.innerText = removed;
        diffStats.classList.remove('hidden');
        mergeSection.classList.remove('hidden');
    }

    function renderDiff(mode) {
        const fragment = document.createDocumentFragment();
        const isLineMode = mode === 'lines' || mode === 'json';

        currentDiff.forEach((part, index) => {
            const span = document.createElement('span');
            const isIncluded = mergeState[index];

            // åŸºç¡€ç±»å
            let classes = ['diff-chunk'];
            if (isLineMode) classes.push('diff-line');
            else classes.push('diff-char');

            // çŠ¶æ€ç±»å
            if (part.added) {
                classes.push('diff-added');
                if (!isIncluded) classes.push('excluded'); // è¢«æ‹’ç»çš„æ–°å¢
                span.title = "æ–°å¢å†…å®¹ï¼šç‚¹å‡»æ‹’ç» (ä¸åˆå¹¶)";
            } else if (part.removed) {
                classes.push('diff-removed');
                if (isIncluded) classes.push('included'); // è¢«ä¿ç•™çš„åˆ é™¤
                span.title = "åˆ é™¤å†…å®¹ï¼šç‚¹å‡»ä¿ç•™ (æ’¤é”€åˆ é™¤)";
            } else {
                classes.push('diff-neutral');
            }

            span.className = classes.join(' ');
            span.appendChild(document.createTextNode(part.value));

            // ç»‘å®šç‚¹å‡»äº‹ä»¶ (ä»…é’ˆå¯¹å˜åŠ¨éƒ¨åˆ†)
            if (part.added || part.removed) {
                span.onclick = () => toggleMerge(index, mode);
            }

            fragment.appendChild(span);
        });

        diffOutput.innerHTML = '';
        diffOutput.appendChild(fragment);
    }

    function toggleMerge(index, mode) {
        // åˆ‡æ¢çŠ¶æ€
        mergeState[index] = !mergeState[index];
        // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°è§†è§‰æ•ˆæœ
        renderDiff(mode);
        // é‡æ–°ç”Ÿæˆåˆå¹¶ç»“æœ
        generateResult();
    }

    function generateResult() {
        let resultText = '';
        currentDiff.forEach((part, index) => {
            if (mergeState[index]) {
                resultText += part.value;
            }
        });
        mergeOutput.value = resultText;
    }

    function copyResult() {
        if (!mergeOutput.value) return;
        mergeOutput.select();
        document.execCommand('copy');
        showMessage('åˆå¹¶ç»“æœå·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'info');
    }

    // ç›‘å¬å¿«æ·é”®
    document.addEventListener('keydown', function (e) {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            compareText();
        }
    });

    // é»˜è®¤ç¤ºä¾‹
    window.onload = function () {
        if (!oldInput.value) {
            oldInput.value = "Hello World\nThis is a stable line.\nI will be removed.";
            newInput.value = "Hello World!\nThis is a stable line.\nI am a new addition.";
        }
    }
</script>
{{ end }}