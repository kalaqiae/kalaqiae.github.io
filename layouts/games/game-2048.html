<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>2048</title>
<style>
:root {
  --bg: #faf8ef;
  --card: #faf8ef;
  --tile-size: 84px;
  --gap: 14px;
  --radius: 6px;
}
* {
  box-sizing: border-box;
}
body {
  margin: 0;
  font-family: 'Segoe UI', 'SF Pro Display', -apple-system, BlinkMacSystemFont, Roboto, Helvetica, Arial, sans-serif;
  background: linear-gradient(135deg, #faf8ef 0%, #e9e6df 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  height: 100vh;
  color: #776e65;
  /* ç¦æ­¢ç”¨æˆ·é€‰ä¸­æ–‡å­—ï¼Œæå‡æ‰‹æœºä½“éªŒ */
  user-select: none; 
  -webkit-user-select: none;
  overflow: hidden; /* é˜²æ­¢æ•´ä¸ªé¡µé¢æ»šåŠ¨ */
}
.card {
  padding: 20px;
  background: var(--card);
  border-radius: 6px;
  display: flex;
  flex-direction: column;
  align-items: center;
  max-width: 500px;
  width: 100%;
}
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
  margin-bottom: 20px;
}
.title {
  font-size: 60px;
  font-weight: 900;
  color: #776e65;
  margin: 0;
}
.controls {
  display: flex;
  gap: 10px;
  align-items: center;
}
.score-box {
  background: #bbada0;
  padding: 8px 16px;
  border-radius: 6px;
  text-align: center;
  color: #fff;
  min-width: 70px;
}
.score-label {
  font-size: 13px;
  font-weight: 700;
  text-transform: uppercase;
}
.score-value {
  font-size: 20px;
  font-weight: 700;
}
button {
  border: none;
  background: #8f7a66;
  color: #f9f6f2;
  padding: 10px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-weight: 600;
  font-size: 16px;
  transition: background 0.2s;
  white-space: nowrap;
}
button:hover {
  background: #7c6b5a;
}
.board-wrap {
  padding: var(--gap);
  background: #bbada0;
  border-radius: 6px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  /* å…³é”®ï¼šé˜²æ­¢åœ¨æ£‹ç›˜ä¸Šæ»‘åŠ¨æ—¶è§¦å‘æµè§ˆå™¨åé€€æˆ–æ»šåŠ¨ */
  touch-action: none;
}
.board {
  position: relative;
  width: calc(var(--tile-size)*4 + var(--gap)*5);
  height: calc(var(--tile-size)*4 + var(--gap)*5);
  border-radius: 6px;
}
.cell {
  position: absolute;
  width: var(--tile-size);
  height: var(--tile-size);
  background: rgba(238, 228, 218, 0.35);
  border-radius: 6px;
}
.tiles {
  position: absolute;
  inset: 0;
  pointer-events: none; /* ç¡®ä¿è§¦æ‘¸äº‹ä»¶ç©¿é€åˆ° board */
}
.tile {
  position: absolute;
  width: var(--tile-size);
  height: var(--tile-size);
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 6px;
  font-weight: 900;
  transition: transform 150ms ease-in-out, left 150ms ease-in-out, top 150ms ease-in-out;
  box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
  z-index: 10;
}
.tile.new {
  animation: pop 300ms cubic-bezier(.2, .9, .3, 1)
}
.tile.merge {
  animation: merge 320ms cubic-bezier(.2, .9, .3, 1);
  z-index: 20;
}
@keyframes pop {
  0% { transform: scale(.2); opacity: 0 }
  60% { transform: scale(1.05); opacity: 1 }
  100% { transform: scale(1) }
}
@keyframes merge {
  0% { transform: scale(1) }
  50% { transform: scale(1.15) }
  100% { transform: scale(1) }
}
/* ç»å…¸é£æ ¼æ–¹å—é¢œè‰² */
.tile-2 { background: #eee4da; color: #776e65; font-size: 48px; }
.tile-4 { background: #ede0c8; color: #776e65; font-size: 48px; }
.tile-8 { background: #f2b179; color: #f9f6f2; font-size: 48px; }
.tile-16 { background: #f59563; color: #f9f6f2; font-size: 42px; }
.tile-32 { background: #f67c5f; color: #f9f6f2; font-size: 42px; }
.tile-64 { background: #f65e3b; color: #f9f6f2; font-size: 42px; }
.tile-128 { background: #edcf72; color: #f9f6f2; font-size: 36px; box-shadow: 0 0 15px rgba(243, 215, 116, 0.4); }
.tile-256 { background: #edcc61; color: #f9f6f2; font-size: 36px; box-shadow: 0 0 15px rgba(243, 215, 116, 0.5); }
.tile-512 { background: #edc850; color: #f9f6f2; font-size: 36px; box-shadow: 0 0 15px rgba(243, 215, 116, 0.6); }
.tile-1024 { background: #edc53f; color: #f9f6f2; font-size: 30px; box-shadow: 0 0 15px rgba(243, 215, 116, 0.7); }
.tile-2048 { background: #edc22e; color: #f9f6f2; font-size: 30px; box-shadow: 0 0 15px rgba(243, 215, 116, 0.8); }

.game-explanation {
  margin-top: 30px;
  line-height: 1.5;
  color: #776e65;
  text-align: center;
  max-width: 500px;
  font-size: 14px;
}

/* æ‰‹æœºé€‚é…æ ·å¼ */
@media (max-width: 520px) {
  :root {
    /* ä¸ JS é€»è¾‘ä¿æŒä¸€è‡´ */
    --tile-size: 70px;
    --gap: 10px;
  }
  .card {
    padding: 10px;
    height: 100%; /* å……æ»¡å±å¹• */
    justify-content: center;
  }
  .header {
    flex-direction: row; /* ä¿æŒå¹¶æ’ï¼Œä½†ç¨å¾®è°ƒæ•´ */
    gap: 10px;
    margin-bottom: 15px;
  }
  .title {
    font-size: 40px;
  }
  .score-box {
    min-width: 60px;
    padding: 5px 10px;
  }
  .score-value {
    font-size: 16px;
  }
  .game-explanation {
    display: none; /* æ‰‹æœºå±å¹•å°ï¼Œéšè—è¯´æ˜èŠ‚çœç©ºé—´ */
  }
  
  /* è°ƒæ•´å°å±å¹•å­—ä½“å¤§å° */
  .tile-2, .tile-4, .tile-8 { font-size: 36px; }
  .tile-16, .tile-32, .tile-64 { font-size: 32px; }
  .tile-128, .tile-256, .tile-512 { font-size: 28px; }
  .tile-1024, .tile-2048 { font-size: 24px; }
}

/* é’ˆå¯¹è¶…å°å±å¹• (iPhone SEç­‰) çš„é¢å¤–é€‚é… */
@media (max-width: 350px) {
  :root {
    --tile-size: 60px;
    --gap: 8px;
  }
  .title { font-size: 32px; }
  .tile { font-size: 28px !important; }
}
</style>
</head>
<body>
<div class="card">
<div class="header">
<h1 class="title">2048</h1>
<div class="controls">
<div class="score-box">
<div class="score-label">åˆ†æ•°</div>
<div class="score-value" id="score">0</div>
</div>
<div class="score-box">
<div class="score-label">æœ€é«˜</div>
<div class="score-value" id="best">0</div>
</div>
<button id="newBtn">æ–°æ¸¸æˆ</button>
</div>
</div>
<div class="board-wrap">
<div class="board" id="board">
<div class="tiles" id="tiles"></div>
</div>
</div>
<div class="game-explanation">
<p><strong>æ¸¸æˆè§„åˆ™ï¼š</strong>ä½¿ç”¨æ–¹å‘é”®æˆ–æ»‘åŠ¨å±å¹•ç§»åŠ¨æ–¹å—ã€‚å½“ä¸¤ä¸ªç›¸åŒæ•°å­—çš„æ–¹å—ç¢°æ’æ—¶ï¼Œå®ƒä»¬ä¼šåˆå¹¶æˆä¸€ä¸ªæ•°å­—ç¿»å€çš„æ–¹å—ã€‚</p>
</div>
</div>
<script>
(function () {
  const SIZE = 4, boardEl = document.getElementById('board'), tilesEl = document.getElementById('tiles');
  const scoreEl = document.getElementById('score'), bestEl = document.getElementById('best'), newBtn = document.getElementById('newBtn');
  let grid = [], score = 0, best = parseInt(localStorage.getItem('2048-best') || '0', 10);
  let hasWon = false;
  bestEl.textContent = best;
  
  // è¿™é‡Œä¸å†å†™æ­»ï¼Œè€Œæ˜¯å®šä¹‰å˜é‡ï¼Œé€šè¿‡ updateDimensions åŠ¨æ€è·å–
  let gap, tileSize;

  // æ ¸å¿ƒä¿®å¤ï¼šæ ¹æ® CSS è®¡ç®—å®é™…çš„åƒç´ å€¼
  function updateDimensions() {
    const rootStyle = getComputedStyle(document.documentElement);
    // è¯»å– CSS å˜é‡ä¸­çš„å€¼å¹¶è½¬ä¸ºæ•°å­—
    tileSize = parseInt(rootStyle.getPropertyValue('--tile-size'));
    gap = parseInt(rootStyle.getPropertyValue('--gap'));
  }

  function makeEmptyGrid() { grid = Array.from({ length: SIZE }, () => Array(SIZE).fill(0)); }
  function randEmpty() { const empties = []; for (let r = 0; r < SIZE; r++)for (let c = 0; c < SIZE; c++)if (grid[r][c] === 0) empties.push([r, c]); return empties.length ? empties[Math.floor(Math.random() * empties.length)] : null; }
  function addRandom() { const pos = randEmpty(); if (!pos) return false; const [r, c] = pos; grid[r][c] = Math.random() < 0.9 ? 2 : 4; renderTile(r, c, true); return true; }
  function setScore(s) { score = s; scoreEl.textContent = score; if (score > best) { best = score; bestEl.textContent = best; localStorage.setItem('2048-best', best); } }
  
  // ç»˜åˆ¶èƒŒæ™¯ç½‘æ ¼
  function setupCells() { 
    // å…ˆæ¸…ç©ºèƒŒæ™¯æ ¼å­ï¼Œé˜²æ­¢ resize æ—¶é‡å¤æ·»åŠ 
    const existingCells = boardEl.querySelectorAll('.cell');
    existingCells.forEach(el => el.remove());

    for (let r = 0; r < SIZE; r++)for (let c = 0; c < SIZE; c++) { 
      const cell = document.createElement('div'); 
      cell.className = 'cell'; 
      cell.style.left = (gap + c * (tileSize + gap)) + 'px'; 
      cell.style.top = (gap + r * (tileSize + gap)) + 'px'; 
      boardEl.appendChild(cell); 
    } 
  }
  
  function clearTiles() { tilesEl.innerHTML = ''; }
  
  function createTileEl(value, r, c, opts = { isNew: false }) {
    const t = document.createElement('div'); t.className = 'tile tile-' + value + (opts.isNew ? ' new' : ''); t.textContent = value;
    t.style.width = tileSize + 'px'; t.style.height = tileSize + 'px';
    // è¿™é‡Œçš„è®¡ç®—é€»è¾‘ç°åœ¨ä¾èµ–åŠ¨æ€æ›´æ–°çš„ gap å’Œ tileSize
    t.style.left = (gap + c * (tileSize + gap)) + 'px'; 
    t.style.top = (gap + r * (tileSize + gap)) + 'px';
    return t;
  }
  
  function renderTile(r, c, isNew) { const t = createTileEl(grid[r][c], r, c, { isNew }); tilesEl.appendChild(t); }
  function renderFull() { tilesEl.innerHTML = ''; for (let r = 0; r < SIZE; r++)for (let c = 0; c < SIZE; c++) { if (grid[r][c]) renderTile(r, c, false); } }
  
  // æ¸¸æˆé€»è¾‘éƒ¨åˆ†ä¿æŒä¸å˜
  function rotateGrid(times) { for (let t = 0; t < times; t++) { const n = Array.from({ length: SIZE }, () => Array(SIZE).fill(0)); for (let r = 0; r < SIZE; r++)for (let c = 0; c < SIZE; c++)n[c][SIZE - 1 - r] = grid[r][c]; grid = n; } }
  function operateRow(row) { const original = row.slice(); let arr = row.filter(x => x !== 0); const mergedFlags = new Array(arr.length).fill(false); for (let i = 0; i < arr.length - 1; i++) { if (arr[i] === arr[i + 1] && !mergedFlags[i] && !mergedFlags[i + 1]) { arr[i] *= 2; score += arr[i]; mergedFlags[i] = true; arr.splice(i + 1, 1); } } while (arr.length < SIZE) arr.push(0); let changed = false; for (let i = 0; i < SIZE; i++)if (arr[i] !== original[i]) { changed = true; break; } return { arr, changed }; }
  function canMove() { for (let r = 0; r < SIZE; r++)for (let c = 0; c < SIZE; c++)if (grid[r][c] === 0) return true; for (let r = 0; r < SIZE; r++)for (let c = 0; c < SIZE - 1; c++)if (grid[r][c] === grid[r][c + 1]) return true; for (let c = 0; c < SIZE; c++)for (let r = 0; r < SIZE - 1; r++)if (grid[r][c] === grid[r + 1][c]) return true; return false; }
  function checkWin() { for (let r = 0; r < SIZE; r++)for (let c = 0; c < SIZE; c++)if (grid[r][c] === 2048) return true; return false; }
  
  function step(direction) {
    let moved = false;
    if (direction === 'left') {
      for (let r = 0; r < SIZE; r++) { const { arr, changed } = operateRow(grid[r]); if (changed) moved = true; grid[r] = arr; }
    } else if (direction === 'right') {
      rotateGrid(2); for (let r = 0; r < SIZE; r++) { const { arr, changed } = operateRow(grid[r]); if (changed) moved = true; grid[r] = arr; } rotateGrid(2);
    } else if (direction === 'up') {
      rotateGrid(3); for (let r = 0; r < SIZE; r++) { const { arr, changed } = operateRow(grid[r]); if (changed) moved = true; grid[r] = arr; } rotateGrid(1);
    } else if (direction === 'down') {
      rotateGrid(1); for (let r = 0; r < SIZE; r++) { const { arr, changed } = operateRow(grid[r]); if (changed) moved = true; grid[r] = arr; } rotateGrid(3);
    }
    if (moved) {
      setScore(score);
      renderFull();
      setTimeout(() => {
        addRandom();
        setScore(score);
        renderFull();
        if (!canMove()) setTimeout(() => alert('æ¸¸æˆç»“æŸ'), 80);
        if (!hasWon && checkWin()) { hasWon = true; setTimeout(() => alert('æ­å–œï¼ä½ è·å¾—äº†2048ï¼ğŸ‰'), 80); }
      }, 250);
    }
  }
  
  window.addEventListener('keydown', e => { switch (e.key) { case 'ArrowLeft': e.preventDefault(); step('left'); break; case 'ArrowRight': e.preventDefault(); step('right'); break; case 'ArrowUp': e.preventDefault(); step('up'); break; case 'ArrowDown': e.preventDefault(); step('down'); break; } });
  
  // è§¦æ‘¸äº‹ä»¶å¤„ç†
  (function () { 
    let sx = 0, sy = 0, tracking = false; 
    boardEl.addEventListener('touchstart', e => { 
      if (e.touches.length === 1) { 
        tracking = true; sx = e.touches[0].clientX; sy = e.touches[0].clientY; 
      } 
    }, { passive: false }); // passive: false å…è®¸æˆ‘ä»¬åœ¨ touchmove ä¸­ preventDefault

    boardEl.addEventListener('touchmove', e => { 
      if (tracking) {
        e.preventDefault(); // å…³é”®ï¼šæ‰‹æŒ‡åœ¨æ£‹ç›˜æ»‘åŠ¨æ—¶ï¼Œç¦æ­¢æµè§ˆå™¨æ»šåŠ¨
      }
    }, { passive: false }); 

    boardEl.addEventListener('touchend', e => { 
      if (!tracking) return; 
      tracking = false; 
      const dx = e.changedTouches[0].clientX - sx, dy = e.changedTouches[0].clientY - sy; 
      if (Math.abs(dx) < 30 && Math.abs(dy) < 30) return; // ç¨å¾®å¢åŠ é˜²è¯¯è§¦é˜ˆå€¼
      if (Math.abs(dx) > Math.abs(dy)) { if (dx > 0) step('right'); else step('left'); } else { if (dy > 0) step('down'); else step('up'); } 
    }); 
  })();
  
  newBtn.addEventListener('click', () => { start(); });

  // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œå®ç°å“åº”å¼é‡ç»˜
  let resizeTimer;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
      updateDimensions(); // æ›´æ–°å°ºå¯¸å˜é‡
      setupCells();       // é‡ç»˜èƒŒæ™¯
      renderFull();       // é‡ç»˜æ‰€æœ‰æ–¹å—
    }, 100);
  });

  function start() {
    updateDimensions(); // å¯åŠ¨æ—¶è·å–å°ºå¯¸
    makeEmptyGrid();
    score = 0;
    setScore(0);
    setupCells();
    clearTiles();
    hasWon = false;
    addRandom();
    addRandom();
    renderFull();
  }
  
  // åˆå§‹åŒ–
  start();
})();
</script>
</body>
</html>